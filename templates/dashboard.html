{% extends "base.html" %}
{% load static %}
{% block content %}

{# ================= DATASET INFO ================= #}
{% if dataset %}
<div class="alert alert-info mb-3">
    Showing results for:
    <strong>{{ dataset.original_filename }}</strong>
</div>
{% endif %}

{# ================= EMPTY STATE ================= #}
{% if not result %}
<div class="card shadow-sm p-5 text-center mb-4">
    <h4>Welcome üëã</h4>
    <p class="text-muted mt-2">
        Upload your first dataset to start fraud detection.
    </p>
    <a href="{% url 'upload' %}" class="btn btn-primary mt-3">
        Upload Dataset
    </a>
</div>

{% else %}

{# ================= METRIC CARDS ================= #}
<div class="row g-4 mb-4">

    <div class="col-md-3">
        <div class="card shadow-sm p-3">
            <h6 class="text-muted">Total Click Events</h6>
            <h2>{{ result.total_clicks|default:0 }}</h2>
            <small class="text-muted">Raw uploaded click data</small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm p-3">
            <h6 class="text-muted">Fraud Click Events</h6>
            <h2 class="text-danger">{{ result.fraud_clicks|default:0 }}</h2>
            <small class="text-muted">Clicks involved in fraudulent behavior</small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm p-3">
            <h6 class="text-muted">Legit Click Events</h6>
            <h2 class="text-success">{{ result.legit_clicks|default:0 }}</h2>
            <small class="text-muted">Normal user interaction clicks</small>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card shadow-sm p-3">
            <h6 class="text-muted">Fraud Ratio</h6>
            <h2>
                {% if result.metrics.summary %}
                    {{ result.metrics.summary.fraud_ratio|floatformat:4 }}
                {% else %}
                    0.0000
                {% endif %}
            </h2>
            <small class="text-muted">Fraud clicks / Total clicks</small>
        </div>
    </div>

</div>

{# ================= PIE CHART ================= #}
<div class="card shadow-sm p-4 mb-4">
    <h5>Fraud vs Legit Click Distribution</h5>
    <div style="height:300px;">
        <canvas id="fraudChart"></canvas>
    </div>
</div>

{# ================= HOURLY TREND ================= #}
<div class="card shadow-sm p-4 mb-4">
    <h5>‚è± Hourly Fraud Click Trends</h5>

    {% if result.metrics.time_trends %}
        <div style="height:320px;">
            <canvas id="timeTrendChart"></canvas>
        </div>
    {% else %}
        <p class="text-muted mt-3">No hourly trend data available.</p>
    {% endif %}
</div>

{# ================= SHAP ================= #}
<div class="card shadow-sm p-4 mb-4">
    <h5>Model Explainability ‚Äì SHAP</h5>

    {% if result.metrics.shap_summary %}
    <div class="table-responsive mt-3">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th>Feature</th>
                    <th>Mean |SHAP| Impact</th>
                </tr>
            </thead>
            <tbody>
                {% for row in result.metrics.shap_summary %}
                <tr>
                    <td>{{ row.feature }}</td>
                    <td>{{ row.mean_shap|floatformat:4 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
        <p class="text-muted mt-2">
            SHAP explanations not available.
        </p>
    {% endif %}
</div>

{# ================= EXPORT ================= #}
<div class="card shadow-sm p-4 mb-4 text-center">
    <h5>üö® Advertiser Actions</h5>

    {% if result.dataset %}
    <a href="{% url 'export_ip_blacklist' result.dataset.id %}"
       class="btn btn-danger px-5 py-2">
        ‚¨á Export IP Blacklist (CSV)
    </a>
    {% endif %}
</div>

{# ================= SCRIPTS ================= #}
<script src="{% static 'js/dashboard.js' %}"></script>

<script>
    renderFraudChart(
        {{ result.fraud_clicks|default:0 }},
        {{ result.legit_clicks|default:0 }}
    );

    const trends = {{ result.metrics.time_trends|default:"[]"|safe }};
    if (trends.length > 0) {
        const labels = trends.map(t => t.hour);
        const fraudClicks = trends.map(t => t.fraud_clicks);
        renderFraudClicksChart(labels, fraudClicks);
    }
</script>

{% endif %}
{% endblock %}






              




